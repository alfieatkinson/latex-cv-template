name: Build and Release CV

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: cv-release
  cancel-in-progress: false

permissions:
  contents: write
  packages: write
  pages: write
  id-token: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt-get update && sudo apt-get install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update
          sudo apt-get install gh -y

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pre-warm cache by pulling existing images
        run: |
          # Pull any existing cache images to speed up the build
          docker pull ghcr.io/${{ github.repository_owner }}/cv-latex:latest || echo "No existing latest image found"
          docker pull ghcr.io/${{ github.repository_owner }}/cv-latex:buildcache || echo "No existing build cache found"

      - name: Build and push devcontainer with cache
        uses: docker/build-push-action@v5
        with:
          context: .devcontainer
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/cv-latex:latest
          cache-from: |
            type=registry,ref=ghcr.io/${{ github.repository_owner }}/cv-latex:buildcache
            type=registry,ref=ghcr.io/${{ github.repository_owner }}/cv-latex:latest
          cache-to: type=registry,ref=ghcr.io/${{ github.repository_owner }}/cv-latex:buildcache,mode=max
          target: final
          platforms: linux/amd64

      - name: Load image for local use
        run: |
          docker pull ghcr.io/${{ github.repository_owner }}/cv-latex:latest
          docker tag ghcr.io/${{ github.repository_owner }}/cv-latex:latest cv-latex:latest

      - name: Build CV in devcontainer
        run: |
          # Ensure output directory exists and has proper permissions
          mkdir -p output

          # Run container as current user to avoid permission issues
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            --user $(id -u):$(id -g) \
            cv-latex:latest \
            bash build.sh

      - name: Generate release filename
        id: filename
        run: |
          DATE=$(date +%Y%m%d)

          # Check if a release with today's date already exists
          EXISTING_RELEASES=$(gh release list --repo ${{ github.repository }} --limit 100 | grep "^${DATE}_AlfieAtkinson_CV" | wc -l)

          if [ "$EXISTING_RELEASES" -eq 0 ]; then
            FILENAME="${DATE}_AlfieAtkinson_CV.pdf"
          else
            VERSION=$((EXISTING_RELEASES + 1))
            FILENAME="${DATE}_AlfieAtkinson_CV_v${VERSION}.pdf"
          fi

          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "Generated filename: $FILENAME"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Rename PDF for release
        run: |
          cp output/redacted.pdf "${{ steps.filename.outputs.filename }}"
          # Also copy to docs for GitHub Pages
          cp output/redacted.pdf "docs/cv.pdf"

      - name: Delete existing cv-latest release
        run: |
          gh release delete cv-latest --yes || true
          git push origin :refs/tags/cv-latest || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release
        run: |
          gh release create cv-latest \
            --title "Latest CV - ${{ steps.filename.outputs.filename }}" \
            --notes "Latest version of Alfie Atkinson's CV (Auto-generated on $(date '+%Y-%m-%d %H:%M:%S UTC'))" \
            --latest \
            "${{ steps.filename.outputs.filename }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          force_orphan: true
